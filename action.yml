name: Automate Pull Request Creation
description: "Creates a pull request from a branch and optionally adds labels and a comment."
author: "owen-6936"
branding:
  icon: "git-pull-request"
  color: "green"

inputs:
  github-token:
    description: "GitHub token for authentication."
    required: true

  branch:
    description: "Source branch for the pull request."
    required: true

  base-branch:
    description: "Target branch for the pull request."
    required: true

  title:
    description: "Title of the pull request."
    required: false
    default: "PR created by automated workflow"

  body:
    description: "Body content of the pull request."
    required: false
    default: "This pull request was automatically created by a workflow."

  labels:
    description: "Comma-separated list of labels to apply."
    required: false
    default: "automated"

  comment-body:
    description: "Optional comment to post after PR creation."
    required: false
    default: ""

outputs:
  pr_number:
    description: "Number of the created pull request."
    value: ${{ steps.create-pr.outputs.pr_number }}
  pr_url:
    description: "URL of the created pull request."
    value: ${{ steps.create-pr.outputs.pr_url }}

runs:
  using: "composite"
  steps:
    - name: Create Pull Request
      id: create-pr
      shell: bash
      run: |
        set -e

        pr_body_md=$(printf "## ðŸ¤– Automated PR\n\nThis pull request was generated from branch \`%s\`\n\n%s\n\n### Workflow Metadata\n- Triggered by: \`%s\`\n- Commit: \`%s\`\n- Actor: \`%s\`" \
          "${{ inputs.branch }}" \
          "${{ inputs.body }}" \
          "${{ github.workflow }}" \
          "${{ github.sha }}" \
          "${{ github.actor }}")

        pr_url=$(gh pr create \
          --title "${{ inputs.title }}" \
          --body "$pr_body_md" \
          --base "${{ inputs.base-branch }}" \
          --head "${{ inputs.branch }}" \
          --repo "${{ github.repository }}")

        pr_number=$(basename "$pr_url")

        echo "pr_number=$pr_number" >> "$GITHUB_OUTPUT"
        echo "pr_url=$pr_url" >> "$GITHUB_OUTPUT"

        echo "âœ… Created PR #$pr_number at $pr_url"
      env:
        GH_TOKEN: ${{ inputs.github-token }}

    - name: Ensure Labels Exist and Apply
      shell: bash
      run: |
        IFS=',' read -ra label_array <<< "${{ inputs.labels }}"
        for label in "${label_array[@]}"; do
          if ! gh label list --repo "${{ github.repository }}" | grep -q "^$label"; then
            echo "ðŸ”§ Creating missing label: $label"
            gh label create "$label" --repo "${{ github.repository }}" --color "cfd3d7" --description "Auto-created by workflow"
          fi
        done

        gh pr edit "$pr_url" --add-label "${{ inputs.labels }}"
      env:
        GH_TOKEN: ${{ inputs.github-token }}

    - name: Add Comment to PR
      if: ${{ inputs.comment-body != '' }}
      shell: bash
      run: |
        gh pr comment "$pr_url" --body "${{ inputs.comment-body }}"
      env:
        GH_TOKEN: ${{ inputs.github-token }}
